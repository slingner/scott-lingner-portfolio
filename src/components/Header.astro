---
import Container from "@components/Container.astro";
import Link from "@components/Link.astro";
import Pelican from "@components/Pelican.astro";
import { SITE } from "@consts";
---

<header transition:persist class="bg-stone-100 dark:bg-stone-900">
  <Container>
    <div class="flex flex-wrap items-center gap-y-2">
      <Link href="/" underline={false}>
        <img
          src="/SCOTT1.png"
          alt={SITE.TITLE}
          class="h-28 w-auto object-contain transition-all dark:opacity-90 dark:brightness-0 dark:invert"
        />
      </Link>

      <nav class="ml-auto mr-4 hidden items-center gap-6 md:flex">
        <Link
          href="/"
          underline={false}
          class="nav-link !text-stone-700 dark:!text-stone-300 hover:!text-stone-900 dark:hover:!text-stone-100 text-sm font-medium"
        >
          Home
        </Link>
        <Link
          href="/news"
          underline={false}
          class="nav-link !text-stone-700 dark:!text-stone-300 hover:!text-stone-900 dark:hover:!text-stone-100 text-sm font-medium"
        >
          News
        </Link>
        <div class="dropdown-wrapper relative">
          <button
            id="work-dropdown-button"
            class="nav-link inline-block text-sm font-medium text-stone-700 transition-all duration-300 hover:text-stone-900 dark:text-stone-300 dark:hover:text-stone-100"
          >
            Work â–¾
          </button>
          <div
            id="work-dropdown-menu"
            class="dropdown-menu invisible absolute left-0 top-full pt-2 opacity-0 transition-all duration-200"
          >
            <div
              class="w-48 rounded-lg border border-stone-300/50 bg-white shadow-lg dark:border-stone-700/50 dark:bg-stone-800"
            >
              <Link
                href="/software-engineering"
                underline={false}
                class="dropdown-link block px-4 py-2 text-sm hover:bg-stone-100 dark:hover:bg-stone-700"
              >
                Software
              </Link>
              <Link
                href="/music"
                underline={false}
                class="dropdown-link block px-4 py-2 text-sm hover:bg-stone-100 dark:hover:bg-stone-700"
              >
                Music
              </Link>
              <Link
                href="/art"
                underline={false}
                class="dropdown-link block px-4 py-2 text-sm hover:bg-stone-100 dark:hover:bg-stone-700"
              >
                Art
              </Link>
              <Link
                href="/photo"
                underline={false}
                class="dropdown-link block px-4 py-2 text-sm hover:bg-stone-100 dark:hover:bg-stone-700"
              >
                Photo
              </Link>
            </div>
          </div>
        </div>
        <Link
          href="/about"
          underline={false}
          class="nav-link !text-stone-700 dark:!text-stone-300 hover:!text-stone-900 dark:hover:!text-stone-100 text-sm font-medium"
        >
          About
        </Link>
      </nav>

      <!-- Search button - Commented out
      <button
        id="magnifying-glass"
        aria-label="Search"
        class="flex items-center rounded border border-stone-300/50 bg-stone-200/80 px-3 py-2 text-xs transition-all duration-300 ease-in-out hover:bg-stone-300/80 hover:text-stone-900 dark:border-stone-600/50 dark:bg-stone-700/80 dark:hover:bg-stone-600/50 dark:hover:text-stone-100"
      >
        <svg
          height="16"
          stroke-linejoin="round"
          viewBox="0 0 16 16"
          width="16"
          style="color: currentcolor;"
          ><path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M3.5 7C3.5 5.067 5.067 3.5 7 3.5C8.933 3.5 10.5 5.067 10.5 7C10.5 7.88461 10.1718 8.69256 9.63058 9.30876L9.30876 9.63058C8.69256 10.1718 7.88461 10.5 7 10.5C5.067 10.5 3.5 8.933 3.5 7ZM9.96544 11.0261C9.13578 11.6382 8.11014 12 7 12C4.23858 12 2 9.76142 2 7C2 4.23858 4.23858 2 7 2C9.76142 2 12 4.23858 12 7C12 8.11014 11.6382 9.13578 11.0261 9.96544L14.0303 12.9697L14.5607 13.5L13.5 14.5607L12.9697 14.0303L9.96544 11.0261Z"
            fill="currentColor"></path></svg
        >
        &nbsp;Search
      </button>
      -->
    </div>
  </Container>
</header>

<Pelican />

<script>
  function setupDropdown() {
    const dropdownButton = document.getElementById("work-dropdown-button");
    const dropdownMenu = document.getElementById("work-dropdown-menu");
    const dropdownWrapper = document.querySelector(".dropdown-wrapper");

    if (!dropdownButton || !dropdownMenu || !dropdownWrapper) return;

    let isOpen = false;

    function openDropdown() {
      isOpen = true;
      dropdownMenu.classList.remove("invisible", "opacity-0");
      dropdownMenu.classList.add("visible", "opacity-100");
    }

    function closeDropdown() {
      isOpen = false;
      dropdownMenu.classList.remove("visible", "opacity-100");
      dropdownMenu.classList.add("invisible", "opacity-0");
    }

    // Open dropdown on hover
    dropdownWrapper.addEventListener("mouseenter", () => {
      openDropdown();
    });

    // Close dropdown when mouse leaves
    dropdownWrapper.addEventListener("mouseleave", () => {
      closeDropdown();
    });

    // Also toggle on button click for mobile/touch
    dropdownButton.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (isOpen) {
        closeDropdown();
      } else {
        openDropdown();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
      const target = e.target as Node;
      if (isOpen && target && !dropdownWrapper.contains(target)) {
        closeDropdown();
      }
    });

    // Close dropdown immediately when clicking a dropdown link
    const dropdownLinks = dropdownMenu.querySelectorAll(".dropdown-link");
    dropdownLinks.forEach(link => {
      link.addEventListener("click", () => {
        // Close immediately without animation for instant navigation
        isOpen = false;
        dropdownMenu.classList.remove("visible", "opacity-100");
        dropdownMenu.classList.add("invisible", "opacity-0");
      });
    });

    // Close dropdown before any navigation starts
    document.addEventListener("astro:before-preparation", () => {
      closeDropdown();
    });

    // Ensure dropdown is closed after navigation completes
    document.addEventListener("astro:page-load", () => {
      closeDropdown();
    });
  }

  function updateActiveNavLinks() {
    const currentPath = window.location.pathname;
    const isWorkActive = currentPath.startsWith("/software-engineering") ||
                         currentPath.startsWith("/music") ||
                         currentPath.startsWith("/art") ||
                         currentPath.startsWith("/photo");

    // Get all nav links
    const navLinks = document.querySelectorAll(".nav-link");

    navLinks.forEach((link) => {
      link.classList.remove("active");
    });

    // Add active class based on current path
    if (currentPath === "/") {
      const homeLink = document.querySelector('a[href="/"].nav-link');
      homeLink?.classList.add("active");
    } else if (currentPath.startsWith("/news")) {
      const newsLink = document.querySelector('a[href="/news"].nav-link');
      newsLink?.classList.add("active");
    } else if (isWorkActive) {
      const workButton = document.querySelector('.dropdown-wrapper button.nav-link');
      workButton?.classList.add("active");
    } else if (currentPath === "/about") {
      const aboutLink = document.querySelector('a[href="/about"].nav-link');
      aboutLink?.classList.add("active");
    }
  }

  // Run on initial load
  setupDropdown();
  updateActiveNavLinks();

  // Run on Astro page navigation
  document.addEventListener("astro:page-load", () => {
    setupDropdown();
    updateActiveNavLinks();
  });
</script>

<style>
  .dropdown-wrapper {
    position: relative;
  }

  .dropdown-menu {
    z-index: 50;
  }

  .nav-link {
    position: relative;
    transition: all 0.3s ease;
    display: inline-block;
    vertical-align: baseline;
  }

  .nav-link::after {
    content: "";
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 0;
    height: 2px;
    background-color: currentColor;
    transition: width 0.3s ease;
  }

  .nav-link:hover::after {
    width: 100%;
  }

  .nav-link.active::after {
    width: 100% !important;
  }
</style>
