---
// Pelican component with flying animation and fish game
---

<div id="pelican-container" class="pelican-wrapper">
  <svg id="pelican-svg" width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
    <!-- Tail -->
    <g id="pelican-tail">
      <rect x="12" y="38" width="4" height="4" fill="#D1D5DB"/>
      <rect x="16" y="38" width="4" height="4" fill="#D1D5DB"/>
      <rect x="8" y="40" width="4" height="2" fill="#D1D5DB"/>
      <rect x="4" y="40" width="4" height="2" fill="#9CA3AF"/>
    </g>

    <!-- Large Wings - Behind body -->
    <g id="pelican-wings-back">
      <g id="wing-back">
        <!-- Wing span -->
        <rect x="16" y="44" width="4" height="4" fill="#9CA3AF"/>
        <rect x="20" y="44" width="4" height="4" fill="#9CA3AF"/>
        <rect x="24" y="46" width="4" height="4" fill="#9CA3AF"/>
        <rect x="12" y="46" width="4" height="4" fill="#9CA3AF"/>
        <rect x="8" y="48" width="4" height="4" fill="#9CA3AF"/>
        <rect x="28" y="48" width="4" height="4" fill="#9CA3AF"/>
        <rect x="4" y="50" width="4" height="2" fill="#78716C"/>
        <rect x="32" y="50" width="4" height="2" fill="#78716C"/>
      </g>
    </g>

    <!-- Body -->
    <g id="pelican-body">
      <rect x="20" y="34" width="4" height="4" fill="#E5E7EB"/>
      <rect x="24" y="34" width="4" height="4" fill="#E5E7EB"/>
      <rect x="28" y="34" width="4" height="4" fill="#E5E7EB"/>
      <rect x="32" y="34" width="4" height="4" fill="#E5E7EB"/>
      <rect x="20" y="38" width="4" height="4" fill="#E5E7EB"/>
      <rect x="24" y="38" width="4" height="4" fill="#E5E7EB"/>
      <rect x="28" y="38" width="4" height="4" fill="#E5E7EB"/>
      <rect x="32" y="38" width="4" height="4" fill="#E5E7EB"/>
      <rect x="36" y="38" width="4" height="4" fill="#E5E7EB"/>
      <rect x="20" y="42" width="4" height="4" fill="#E5E7EB"/>
      <rect x="24" y="42" width="4" height="4" fill="#E5E7EB"/>
      <rect x="28" y="42" width="4" height="4" fill="#E5E7EB"/>
      <rect x="32" y="42" width="4" height="4" fill="#E5E7EB"/>
    </g>

    <!-- Large Wings - In front of body -->
    <g id="pelican-wings-front">
      <g id="wing-front">
        <rect x="24" y="46" width="4" height="4" fill="#D1D5DB"/>
        <rect x="28" y="46" width="4" height="4" fill="#D1D5DB"/>
        <rect x="32" y="46" width="4" height="4" fill="#D1D5DB"/>
        <rect x="36" y="48" width="4" height="4" fill="#D1D5DB"/>
        <rect x="40" y="50" width="4" height="4" fill="#D1D5DB"/>
        <rect x="44" y="50" width="4" height="2" fill="#9CA3AF"/>
        <rect x="20" y="48" width="4" height="2" fill="#D1D5DB"/>
      </g>
    </g>

    <!-- Head -->
    <g id="pelican-head">
      <rect x="36" y="30" width="4" height="4" fill="#E5E7EB"/>
      <rect x="36" y="34" width="4" height="4" fill="#E5E7EB"/>
      <rect x="40" y="30" width="4" height="4" fill="#E5E7EB"/>
      <rect x="40" y="34" width="4" height="4" fill="#E5E7EB"/>
      <!-- Eye -->
      <rect x="42" y="32" width="2" height="2" fill="#1F2937"/>
    </g>

    <!-- Large Beak - Upper -->
    <g id="pelican-beak">
      <rect x="44" y="30" width="4" height="4" fill="#FFA500"/>
      <rect x="48" y="30" width="4" height="4" fill="#FFA500"/>
      <rect x="52" y="30" width="4" height="4" fill="#FFA500"/>
      <rect x="56" y="32" width="4" height="2" fill="#FFA500"/>
      <rect x="60" y="32" width="4" height="2" fill="#FF8C00"/>
    </g>

    <!-- Large Pouch - Lower Beak -->
    <g id="pelican-pouch">
      <rect x="44" y="34" width="4" height="4" fill="#FF8C00"/>
      <rect x="48" y="34" width="4" height="4" fill="#FF8C00"/>
      <rect x="52" y="34" width="4" height="4" fill="#FF8C00"/>
      <rect x="56" y="34" width="4" height="4" fill="#FF8C00"/>
      <rect x="44" y="38" width="4" height="4" fill="#FF8C00"/>
      <rect x="48" y="38" width="4" height="4" fill="#FF8C00"/>
      <rect x="52" y="38" width="4" height="4" fill="#FF8C00"/>
      <rect x="56" y="36" width="4" height="4" fill="#FF8C00"/>
      <rect x="40" y="38" width="4" height="4" fill="#FF8C00"/>
      <rect x="40" y="42" width="4" height="4" fill="#FF8C00"/>
      <rect x="44" y="42" width="4" height="4" fill="#FF8C00"/>
      <rect x="48" y="42" width="4" height="4" fill="#FF8C00"/>
      <rect x="40" y="46" width="4" height="2" fill="#FF8C00"/>
      <rect x="44" y="46" width="4" height="2" fill="#FF8C00"/>
    </g>

    <!-- Legs -->
    <g id="pelican-legs">
      <rect x="26" y="50" width="2" height="4" fill="#FFA500"/>
      <rect x="32" y="50" width="2" height="4" fill="#FFA500"/>
      <!-- Feet -->
      <rect x="24" y="54" width="6" height="2" fill="#FFA500"/>
      <rect x="30" y="54" width="6" height="2" fill="#FFA500"/>
    </g>
  </svg>
</div>

<!-- Falling fish container -->
<div id="falling-fish-container"></div>

<!-- Fisherman at bottom right -->
<div id="fisherman-container" class="fisherman-wrapper" role="button" tabindex="0" aria-label="Click to start pelican fishing game. Use left and right arrow keys to move and catch fish. Press ESC to stop.">
  <div id="catch-counter" class="catch-counter" aria-live="polite" aria-atomic="true">Catches: 0</div>
  <div id="game-status" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>
  <svg id="fisherman-svg" width="100" height="140" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg">
    <!-- Hat -->
    <g id="hat">
      <rect x="38" y="20" width="4" height="4" fill="#FCD34D"/>
      <rect x="42" y="16" width="4" height="4" fill="#FCD34D"/>
      <rect x="46" y="16" width="4" height="4" fill="#FCD34D"/>
      <rect x="50" y="16" width="4" height="4" fill="#FCD34D"/>
      <rect x="54" y="20" width="4" height="4" fill="#FCD34D"/>
      <rect x="42" y="20" width="4" height="4" fill="#FCD34D"/>
      <rect x="46" y="20" width="4" height="4" fill="#FCD34D"/>
      <rect x="50" y="20" width="4" height="4" fill="#FCD34D"/>
    </g>

    <!-- Head -->
    <g id="head">
      <rect x="42" y="24" width="4" height="4" fill="#FBBF24"/>
      <rect x="46" y="24" width="4" height="4" fill="#FBBF24"/>
      <rect x="50" y="24" width="4" height="4" fill="#FBBF24"/>
      <!-- Eyes -->
      <rect x="44" y="26" width="2" height="2" fill="#1F2937"/>
      <rect x="50" y="26" width="2" height="2" fill="#1F2937"/>
    </g>

    <!-- Yellow Raincoat -->
    <g id="raincoat">
      <!-- Shoulders -->
      <rect x="38" y="28" width="4" height="4" fill="#FCD34D"/>
      <rect x="42" y="28" width="4" height="4" fill="#FCD34D"/>
      <rect x="46" y="28" width="4" height="4" fill="#FCD34D"/>
      <rect x="50" y="28" width="4" height="4" fill="#FCD34D"/>
      <rect x="54" y="28" width="4" height="4" fill="#FCD34D"/>
      <!-- Body -->
      <rect x="38" y="32" width="4" height="4" fill="#FCD34D"/>
      <rect x="42" y="32" width="4" height="4" fill="#FCD34D"/>
      <rect x="46" y="32" width="4" height="4" fill="#FCD34D"/>
      <rect x="50" y="32" width="4" height="4" fill="#FCD34D"/>
      <rect x="54" y="32" width="4" height="4" fill="#FCD34D"/>
      <rect x="38" y="36" width="4" height="4" fill="#FCD34D"/>
      <rect x="42" y="36" width="4" height="4" fill="#FCD34D"/>
      <rect x="46" y="36" width="4" height="4" fill="#FCD34D"/>
      <rect x="50" y="36" width="4" height="4" fill="#FCD34D"/>
      <rect x="54" y="36" width="4" height="4" fill="#FCD34D"/>
      <rect x="38" y="40" width="4" height="4" fill="#FCD34D"/>
      <rect x="42" y="40" width="4" height="4" fill="#FCD34D"/>
      <rect x="46" y="40" width="4" height="4" fill="#FCD34D"/>
      <rect x="50" y="40" width="4" height="4" fill="#FCD34D"/>
      <rect x="54" y="40" width="4" height="4" fill="#FCD34D"/>
      <!-- Buttons -->
      <rect x="46" y="34" width="2" height="2" fill="#F59E0B"/>
      <rect x="46" y="38" width="2" height="2" fill="#F59E0B"/>
    </g>

    <!-- Arms -->
    <g id="arms">
      <rect x="34" y="32" width="4" height="4" fill="#FCD34D"/>
      <rect x="30" y="36" width="4" height="4" fill="#FCD34D"/>
      <rect x="58" y="32" width="4" height="4" fill="#FCD34D"/>
      <rect x="62" y="36" width="4" height="4" fill="#FCD34D"/>
    </g>

    <!-- Legs -->
    <g id="legs">
      <rect x="42" y="44" width="4" height="4" fill="#92400E"/>
      <rect x="50" y="44" width="4" height="4" fill="#92400E"/>
      <rect x="42" y="48" width="4" height="4" fill="#92400E"/>
      <rect x="50" y="48" width="4" height="4" fill="#92400E"/>
      <!-- Boots -->
      <rect x="40" y="52" width="8" height="4" fill="#1F2937"/>
      <rect x="48" y="52" width="8" height="4" fill="#1F2937"/>
    </g>

    <!-- Fishing Net - Held Up with Round Hoop -->
    <g id="net">
      <!-- Handle going up from hand -->
      <rect x="26" y="28" width="2" height="12" fill="#78716C"/>
      <rect x="28" y="28" width="2" height="12" fill="#78716C"/>

      <!-- Round net hoop using ellipse -->
      <ellipse cx="24" cy="21" rx="15" ry="7" fill="none" stroke="#78716C" stroke-width="2"/>

      <!-- Inner circle for depth -->
      <ellipse cx="24" cy="21" rx="13" ry="5.5" fill="none" stroke="#57534E" stroke-width="1" opacity="0.5"/>

      <!-- Net mesh pattern inside circle - arranged in circular pattern -->
      <rect x="16" y="19" width="2" height="2" fill="#9CA3AF"/>
      <rect x="20" y="18" width="2" height="2" fill="#9CA3AF"/>
      <rect x="24" y="18" width="2" height="2" fill="#9CA3AF"/>
      <rect x="28" y="19" width="2" height="2" fill="#9CA3AF"/>

      <rect x="14" y="21" width="2" height="2" fill="#9CA3AF"/>
      <rect x="18" y="20" width="2" height="2" fill="#9CA3AF"/>
      <rect x="22" y="20" width="2" height="2" fill="#9CA3AF"/>
      <rect x="26" y="20" width="2" height="2" fill="#9CA3AF"/>
      <rect x="30" y="21" width="2" height="2" fill="#9CA3AF"/>

      <rect x="16" y="22" width="2" height="2" fill="#9CA3AF"/>
      <rect x="20" y="22" width="2" height="2" fill="#9CA3AF"/>
      <rect x="24" y="22" width="2" height="2" fill="#9CA3AF"/>
      <rect x="28" y="22" width="2" height="2" fill="#9CA3AF"/>
    </g>
  </svg>
  <div id="fisherman-hint" class="fisherman-hint">
    <div class="hint-line">Click to start game</div>
    <div class="hint-line"><kbd>‚Üê</kbd> <kbd>‚Üí</kbd> to move</div>
    <div class="hint-line"><kbd>ESC</kbd> to stop</div>
  </div>
</div>

<!-- Confetti container -->
<div id="confetti-container"></div>

<style>
  /* Pelican - Desktop only */
  .pelican-wrapper {
    position: fixed;
    z-index: 9999;
    pointer-events: auto;
    will-change: transform;
    cursor: pointer;
  }

  @media (max-width: 1024px) {
    .pelican-wrapper {
      display: none;
    }
  }

  #pelican-svg {
    filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.2));
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
  }

  #pelican-svg:hover {
    filter: drop-shadow(2px 2px 8px rgba(0, 0, 0, 0.4));
  }

  /* Wing flap animation */
  @keyframes flapWings {
    0% {
      transform: translateY(0) rotate(0deg);
    }
    50% {
      transform: translateY(-8px) rotate(-15deg);
    }
    100% {
      transform: translateY(0) rotate(0deg);
    }
  }

  .flapping #wing-front {
    animation: flapWings 0.6s ease-in-out infinite;
    transform-origin: 30% 50%;
  }

  .flapping #wing-back {
    animation: flapWings 0.6s ease-in-out infinite 0.15s;
    transform-origin: 30% 50%;
  }

  /* Falling fish - Desktop only */
  #falling-fish-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9998;
  }

  @media (max-width: 1024px) {
    #falling-fish-container {
      display: none;
    }
  }

  .falling-fish {
    position: fixed;
    will-change: transform;
    z-index: 9998;
  }

  .falling-fish svg {
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
  }

  @keyframes fallDown {
    0% {
      transform: translateY(0) rotate(0deg);
      opacity: 1;
    }
    100% {
      transform: translateY(calc(100vh + 100px)) rotate(360deg);
      opacity: 1;
    }
  }

  /* Fisherman - Desktop only */
  .fisherman-wrapper {
    position: fixed;
    bottom: 20px;
    right: 40px;
    z-index: 9999;
    cursor: pointer;
    transition: transform 0.1s ease-out;
  }

  @media (max-width: 1024px) {
    .fisherman-wrapper {
      display: none;
    }
  }

  .fisherman-wrapper.active {
    cursor: default;
  }

  #fisherman-svg {
    filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.2));
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
  }

  #fisherman-svg:hover {
    filter: drop-shadow(2px 2px 8px rgba(0, 0, 0, 0.4));
  }

  .fisherman-hint {
    position: absolute;
    top: -190px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    font-family: 'Courier New', monospace;
  }

  .hint-line {
    text-align: center;
    margin: 2px 0;
  }

  .fisherman-hint kbd {
    display: inline-block;
    padding: 2px 6px;
    background: #374151;
    border: 1px solid #4B5563;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 11px;
    box-shadow: 0 2px 0 #1F2937;
  }

  .fisherman-wrapper:hover .fisherman-hint {
    opacity: 1;
  }

  .fisherman-wrapper.active .fisherman-hint {
    opacity: 0;
  }

  .fisherman-wrapper:focus {
    outline: none;
  }

  .catch-counter {
    position: absolute;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Courier New', monospace;
    font-size: 20px;
    font-weight: bold;
    color: #1F2937;
    text-shadow: 2px 2px 0px #FCD34D;
    image-rendering: pixelated;
    -webkit-font-smoothing: none;
    -moz-osx-font-smoothing: grayscale;
    pointer-events: none;
    display: none;
  }

  .catch-counter.visible {
    display: block;
  }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    margin: -1px;
    padding: 0;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* Confetti - Desktop only */
  #confetti-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10000;
  }

  @media (max-width: 1024px) {
    #confetti-container {
      display: none;
    }
  }

  .confetti {
    position: absolute;
    width: 10px;
    height: 10px;
    animation: confettiFall 3s linear forwards;
  }

  @keyframes confettiFall {
    from {
      transform: translateY(0) rotate(0deg);
      opacity: 1;
    }
    to {
      transform: translateY(100vh) rotate(720deg);
      opacity: 0;
    }
  }
</style>

<script is:inline>
  // Use is:inline to persist across page transitions
  (function() {
    const pelicanContainer = document.getElementById('pelican-container');
    const pelicanSvg = document.getElementById('pelican-svg');
    const fallingFishContainer = document.getElementById('falling-fish-container');
    const fishermanContainer = document.getElementById('fisherman-container');
    const confettiContainer = document.getElementById('confetti-container');

    if (!pelicanContainer || !pelicanSvg || !fallingFishContainer || !fishermanContainer) return;

    let pelicanX = 80;
    let pelicanY = 30;
    let targetX = pelicanX;
    let targetY = pelicanY;
    let isFlying = false;
    let isActivated = false;
    let isFirstFlight = true;
    let facingRight = true;
    let headerElement = null;
    let headerHeight = 100;
    let headerTop = 0;

    // Game state
    let fishermanActive = false;
    let fishermanX = 0;
    let activeFish = null;
    let catchCount = 0;
    const catchCounter = document.getElementById('catch-counter');
    const gameStatus = document.getElementById('game-status');

    // Find and measure the header element
    const findHeader = () => {
      headerElement = document.querySelector('header');
      if (headerElement) {
        const rect = headerElement.getBoundingClientRect();
        headerHeight = rect.height;
        headerTop = rect.top;
      }
      return headerElement;
    };

    findHeader();
    window.addEventListener('resize', findHeader);

    // Flight patterns - varied angles through header
    const flightPatterns = [
      { startX: -100, startY: 0.8, endX: 1.2, endY: 0.2 },
      { startX: -100, startY: 0.5, endX: 1.2, endY: 0.3 },
      { startX: -100, startY: 0.3, endX: 1.2, endY: 0.7 },
      { startX: -100, startY: 0.6, endX: 1.2, endY: 0.4 },
      { startX: 1.2, startY: 0.8, endX: -100, endY: 0.2 },
      { startX: 1.2, startY: 0.5, endX: -100, endY: 0.3 },
      { startX: 1.2, startY: 0.3, endX: -100, endY: 0.7 },
      { startX: 1.2, startY: 0.6, endX: -100, endY: 0.4 },
    ];

    // Random flight pattern
    const startRandomFlight = () => {
      isFlying = true;
      const viewportWidth = window.innerWidth;

      // Reset fish drop tracking and schedule 2 random drops
      fishDroppedCount = 0;
      nextDropTime1 = Date.now() + 1000 + Math.random() * 3000; // 1-4 seconds
      nextDropTime2 = Date.now() + 2000 + Math.random() * 4000; // 2-6 seconds

      // First flight: take off from seated position and fly off screen
      if (isFirstFlight) {
        isFirstFlight = false;
        // Take off to the right and slightly up, flying off screen
        targetX = viewportWidth + 100;
        targetY = headerTop + (headerHeight * 0.3);
        facingRight = true;
        pelicanSvg.style.transform = 'scaleX(1)';
      } else {
        // Normal random flight patterns
        const pattern = flightPatterns[Math.floor(Math.random() * flightPatterns.length)];

        const startXPos = pattern.startX < 0 ? pattern.startX : viewportWidth * pattern.startX;
        const endXPos = pattern.endX < 0 ? pattern.endX : viewportWidth * pattern.endX;
        const startYPos = headerTop + (headerHeight * pattern.startY);
        const endYPos = headerTop + (headerHeight * pattern.endY);

        pelicanX = startXPos;
        pelicanY = startYPos;
        targetX = endXPos;
        targetY = endYPos;

        facingRight = endXPos > startXPos;
        pelicanSvg.style.transform = facingRight ? 'scaleX(1)' : 'scaleX(-1)';
        pelicanContainer.style.transform = `translate(${pelicanX}px, ${pelicanY}px)`;
      }

      pelicanSvg.classList.add('flapping');
    };

    // Track fish drops during current flight
    let fishDroppedCount = 0;
    let nextDropTime1 = 0;
    let nextDropTime2 = 0;

    // Drop fish from pelican
    const dropFish = () => {
      if (activeFish) return;

      const pelicanRect = pelicanContainer.getBoundingClientRect();
      const currentPelicanX = pelicanRect.left + 40;
      const currentPelicanY = pelicanRect.top + 40;

      const fish = document.createElement('div');
      fish.className = 'falling-fish';

      fish.style.position = 'fixed';
      fish.style.left = `${currentPelicanX}px`;
      fish.style.top = `${currentPelicanY}px`;
      fish.style.pointerEvents = 'none';
      fish.style.zIndex = '9998';

      fish.innerHTML = `
        <svg width="32" height="32" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <rect x="8" y="10" width="2" height="2" fill="#60A5FA"/>
          <rect x="10" y="8" width="2" height="2" fill="#60A5FA"/>
          <rect x="12" y="8" width="2" height="2" fill="#60A5FA"/>
          <rect x="14" y="10" width="2" height="2" fill="#60A5FA"/>
          <rect x="10" y="10" width="2" height="2" fill="#93C5FD"/>
          <rect x="12" y="10" width="2" height="2" fill="#93C5FD"/>
          <rect x="12" y="12" width="2" height="2" fill="#60A5FA"/>
          <rect x="10" y="12" width="2" height="2" fill="#60A5FA"/>
          <rect x="6" y="8" width="2" height="2" fill="#60A5FA"/>
          <rect x="6" y="12" width="2" height="2" fill="#60A5FA"/>
          <rect x="4" y="10" width="2" height="2" fill="#60A5FA"/>
          <rect x="12" y="9" width="1" height="1" fill="#1F2937"/>
        </svg>
      `;

      document.body.appendChild(fish);
      activeFish = fish;

      fish.offsetHeight;
      fish.style.animation = 'fallDown 5s linear forwards';

      setTimeout(() => {
        if (fish.parentElement) {
          fish.remove();
          activeFish = null;
        }
      }, 5000);
    };

    // Fisherman controls - Click to activate game (fisherman + pelican)
    fishermanContainer.addEventListener('click', (e) => {
      if (!fishermanActive) {
        fishermanActive = true;
        fishermanContainer.classList.add('active');
        const rect = fishermanContainer.getBoundingClientRect();
        fishermanX = rect.left;

        // Also activate pelican flight
        if (!isActivated) {
          isActivated = true;
          pelicanContainer.classList.add('flying');
          startRandomFlight();
        }

        if (gameStatus) {
          gameStatus.textContent = 'Game started! Use left and right arrow keys to move and catch fish. Press ESC to stop.';
        }
      }
    });

    // Also support Enter/Space for accessibility
    fishermanContainer.addEventListener('keydown', (e) => {
      if ((e.key === 'Enter' || e.key === ' ') && !fishermanActive) {
        e.preventDefault();
        fishermanContainer.click();
      }
    });

    // Keyboard controls for fisherman and pelican
    document.addEventListener('keydown', (e) => {
      // ESC to stop game completely
      if (e.key === 'Escape' && (isFlying || fishermanActive)) {
        e.preventDefault();

        // Stop pelican
        isFlying = false;
        isActivated = false;
        isFirstFlight = true;
        pelicanSvg.classList.remove('flapping');
        pelicanContainer.classList.remove('flying');
        pelicanX = 80;
        pelicanY = 30;
        pelicanContainer.style.transform = `translate(${pelicanX}px, ${pelicanY}px)`;

        // Stop fisherman
        fishermanActive = false;
        fishermanContainer.classList.remove('active');
        fishermanContainer.style.right = '40px';
        fishermanContainer.style.left = 'auto';

        // Remove any active fish
        if (activeFish) {
          activeFish.remove();
          activeFish = null;
        }

        // Reset catch count and hide counter
        catchCount = 0;
        if (catchCounter) {
          catchCounter.textContent = 'Catches: 0';
          catchCounter.classList.remove('visible');
        }

        if (gameStatus) {
          gameStatus.textContent = 'Game stopped. Click fisherman to start again.';
        }
        return;
      }

      if (!fishermanActive) return;

      const moveSpeed = 15;
      const minX = 0;
      const maxX = window.innerWidth - 100;

      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        fishermanX = Math.max(minX, fishermanX - moveSpeed);
        fishermanContainer.style.right = 'auto';
        fishermanContainer.style.left = `${fishermanX}px`;
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        fishermanX = Math.min(maxX, fishermanX + moveSpeed);
        fishermanContainer.style.right = 'auto';
        fishermanContainer.style.left = `${fishermanX}px`;
      }
    });

    // Check for fish collision with round net
    const checkFishCatch = () => {
      if (!activeFish) return;

      const fishRect = activeFish.getBoundingClientRect();

      if (fishermanActive) {
        const fishermanRect = fishermanContainer.getBoundingClientRect();

        // Round net area - ellipse centered at (24, 21) with rx=15, ry=7 in 100x140 viewBox
        const netCenterX = fishermanRect.left + (fishermanRect.width * 0.24);
        const netCenterY = fishermanRect.top + (fishermanRect.height * 0.15);
        const netRadiusX = fishermanRect.width * 0.15;
        const netRadiusY = fishermanRect.height * 0.05;

        const fishCenterX = fishRect.left + fishRect.width / 2;
        const fishCenterY = fishRect.top + fishRect.height / 2;

        // Ellipse collision detection
        const normalizedX = (fishCenterX - netCenterX) / netRadiusX;
        const normalizedY = (fishCenterY - netCenterY) / netRadiusY;
        const inEllipse = (normalizedX * normalizedX + normalizedY * normalizedY) <= 1;

        if (inEllipse) {
          activeFish.remove();
          activeFish = null;
          catchCount++;
          if (catchCounter) {
            catchCounter.textContent = `Catches: ${catchCount}`;
            // Show counter after first catch
            if (catchCount >= 1) {
              catchCounter.classList.add('visible');
            }
          }
          if (gameStatus) {
            gameStatus.textContent = `Fish caught! Total catches: ${catchCount}`;
          }

          // Special fireworks at 10 catches
          if (catchCount === 10) {
            triggerPixelatedFireworks();
          } else {
            triggerConfetti();
          }
        }
      }
    };

    // Confetti animation
    const triggerConfetti = () => {
      const colors = ['#FCD34D', '#60A5FA', '#F87171', '#34D399', '#A78BFA', '#F472B6'];

      for (let i = 0; i < 100; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = `${Math.random() * 100}%`;
          confetti.style.top = '-10px';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = `${Math.random() * 0.5}s`;
          confetti.style.animationDuration = `${2 + Math.random() * 2}s`;

          confettiContainer.appendChild(confetti);

          setTimeout(() => {
            confetti.remove();
          }, 4000);
        }, i * 20);
      }
    };

    // Pixelated fireworks at 10 catches
    const triggerPixelatedFireworks = () => {
      const colors = ['#FCD34D', '#60A5FA', '#F87171', '#34D399', '#A78BFA', '#F472B6', '#FBBF24', '#93C5FD'];
      const fishermanRect = fishermanContainer.getBoundingClientRect();
      const centerX = fishermanRect.left + fishermanRect.width / 2;
      const centerY = fishermanRect.top + fishermanRect.height / 2;

      // Create multiple firework bursts over 5 seconds
      const duration = 5000;
      const burstInterval = 300; // New burst every 300ms
      const numBursts = duration / burstInterval;

      for (let burst = 0; burst < numBursts; burst++) {
        setTimeout(() => {
          // Each burst creates 20 pixelated particles
          for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.style.position = 'fixed';
            particle.style.left = `${centerX}px`;
            particle.style.top = `${centerY}px`;
            particle.style.width = '8px';
            particle.style.height = '8px';
            particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            particle.style.pointerEvents = 'none';
            particle.style.zIndex = '10001';
            particle.style.imageRendering = 'pixelated';

            // Random explosion direction
            const angle = Math.random() * Math.PI * 2;
            const velocity = 100 + Math.random() * 150;
            const xVel = Math.cos(angle) * velocity;
            const yVel = Math.sin(angle) * velocity;

            document.body.appendChild(particle);

            let posX = centerX;
            let posY = centerY;
            let velX = xVel;
            let velY = yVel;
            const gravity = 200;
            let opacity = 1;
            const startTime = Date.now();

            const animateParticle = () => {
              const elapsed = (Date.now() - startTime) / 1000;

              if (elapsed < 1.5) {
                velY += gravity * 0.016;
                posX += velX * 0.016;
                posY += velY * 0.016;
                opacity = Math.max(0, 1 - elapsed / 1.5);

                particle.style.left = `${posX}px`;
                particle.style.top = `${posY}px`;
                particle.style.opacity = opacity;

                requestAnimationFrame(animateParticle);
              } else {
                particle.remove();
              }
            };

            animateParticle();
          }
        }, burst * burstInterval);
      }

      if (gameStatus) {
        gameStatus.textContent = 'üéâ 10 CATCHES! SPECTACULAR FIREWORKS! üéâ';
      }
    };

    // Animation loop
    const animate = () => {
      if (isFlying) {
        const dx = targetX - pelicanX;
        const dy = targetY - pelicanY;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance > 3) {
          const speed = 2;
          pelicanX += (dx / distance) * speed;
          pelicanY += (dy / distance) * speed;

          pelicanContainer.style.transform = `translate(${pelicanX}px, ${pelicanY}px)`;

          // Auto-drop fish at scheduled times
          const now = Date.now();
          if (fishDroppedCount < 2) {
            if (fishDroppedCount === 0 && now >= nextDropTime1 && !activeFish) {
              dropFish();
              fishDroppedCount++;
            } else if (fishDroppedCount === 1 && now >= nextDropTime2 && !activeFish) {
              dropFish();
              fishDroppedCount++;
            }
          }
        } else {
          pelicanX = targetX;
          pelicanY = targetY;
          pelicanContainer.style.transform = `translate(${pelicanX}px, ${pelicanY}px)`;

          isFlying = false;
          pelicanSvg.classList.remove('flapping');

          setTimeout(() => {
            startRandomFlight();
          }, 4000 + Math.random() * 6000);
        }
      }

      checkFishCatch();
      requestAnimationFrame(animate);
    };

    // Initialize position to left of logo
    pelicanContainer.style.transform = `translate(${pelicanX}px, ${pelicanY}px)`;

    // Start animation loop (but don't start flying until clicked)
    animate();

    // Re-initialize on page show (for back/forward navigation)
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) {
        findHeader();
        // Don't auto-start, user must click to activate
      }
    });
  })();
</script>
